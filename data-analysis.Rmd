---
title: Traffic Data Analysis
output: html_document
---


### loading data
```{r}
library(dplyr)
library(ggplot2)
library(reader)
df <- read.csv("all-semi-unique.csv")

```
### removing advertisments information
```{r}
cols <- grep("ad/*",names(df),value=F)
df2 <- df[,-cols]
```
### checking for columns with only one value
```{r}
unique(df2$rd.rp.type)
df2 <- subset(df2,select=-c(rd.rp.type))
unique(df2$rd.img)
unique(df2$rd.cl)
df2 <- subset(df2,select=-c(rd.cl))
```
### removing some columns
```{r}
df2 <- subset(df2,select=-c(rd.img))
```
### check for duplicates in rows
```{r}
df3 <- subset(df2,select=-c(rd.hr,rd.mn,rd.rp.hr,rd.rp.mn,crawl_date))
df3 <- df3[!duplicated(df3),]
```
### add new columns for the dates of the road and comment
```{r}
x <- strptime(df2[,"crawl_date"],format = "%a %b %d %H:%M",tz = "UTC")
hrs <- function(u) {
 x <- u * 3600
 return(x)
}
mns <- function(m) {
 x <- m * 60
 return(x)
}
df2$tmp_date <- x
df2 <- mutate(df2, date= tmp_date-hrs(rd.hr)-mns(rd.mn))
df2 <- mutate(df2, rp.date= tmp_date-hrs(rd.rp.hr)-mns(rd.rp.mn))
df2 <- subset(df2,select=-c(rd.hr,rd.mn,rd.rp.hr,rd.rp.mn,crawl_date,tmp_date))
df2 <- df2[!duplicated(df2),]
```
### check for further duplicates in cmid
```{r}
length(unique(df2$rd.rp.cmid))
```
### accommodate for diffrences in seconds
```{r}
data <- subset(df2, !duplicated(df2[,'rd.rp.cmid']))
```
### examine the frequency for each status for the comments 
```{r}
qplot(rd.rp.stid,data = data)
```

### examine rows with comment status that is NA
```{r}
sum(is.na(data$rd.rp.stid))
not.labeled <- data[is.na(data$rd.rp.stid),]
```

### examine the status  that corresponds to each status id
```{r eval}
t <- (data[ which(data$rd.rp.stid==1), ])
t <- (data[ which(data$rd.rp.stid==2), ])
t <- (data[ which(data$rd.rp.stid==3), ])
t <- (data[ which(data$rd.rp.stid==4), ])
t <- (data[ which(data$rd.rp.stid==5), ])
t <- (data[ which(data$rd.rp.stid==6), ])
t <- (data[ which(data$rd.rp.stid==7), ])
t <- (data[ which(data$rd.rp.stid==8), ])
t <- (data[ which(data$rd.rp.stid==10), ])
```

### examine stid = NA
```{r}
na.stid <- data[is.na(data$rd.rp.stid) == TRUE,]
```

### comments containing "clear" sometimes have NA value for stid. examine other values given to it.
```{r}
m <- data[grepl("(.)*clear(.)*", data$rd.rp.cm) == TRUE,]
m <- m[!is.na(m$rd.rp.stid),]
count(m[m$rd.rp.stid == 1,])
count(m[m$rd.rp.stid == 2,])
count(m[m$rd.rp.stid == 3,])
count(m[m$rd.rp.stid == 4,])
count(m[m$rd.rp.stid == 5,])
count(m[m$rd.rp.stid == 6,])
count(m[m$rd.rp.stid == 7,])
count(m[m$rd.rp.stid == 8,])
count(m[m$rd.rp.stid == 9,])
count(m[m$rd.rp.stid == 10,])
```

### replace stid that is equal to NA in "clear" comments with 1
```{r}
data$rd.rp.stid <- ifelse(grepl("(.)*clear(.)*", data$rd.rp.cm), 1,data$rd.rp.stid)
sum(is.na(data$rd.rp.stid))
not.labeled <- data[is.na(data$rd.rp.stid),]
data2 <- data[!is.na(data$rd.rp.stid),]
qplot(rd.rp.stid,data = data2)
```

### adding a column for positive comments (1,2,3)
```{r}
data2$pos.com <- ifelse(data2$rd.rp.stid == 1 | data2$rd.rp.stid == 2 | data2$rd.rp.stid == 3 , 1,0)
```

### adding a column for negative comments (4,5,7,8,9,10)
```{r}
data2$neg.com <- ifelse(data2$rd.rp.stid == 4 | data2$rd.rp.stid == 5 | data2$rd.rp.stid == 7 | data2$rd.rp.stid == 8 | data2$rd.rp.stid == 9 | data2$rd.rp.stid == 10 , 1,0)
```

### examine roads with the most positive comments in general
```{r}
positive <- data2 %>% group_by(rd.ri) %>% summarise(sum.pos = sum(pos.com))
ggplot(positive, aes(positive$rd.ri,positive$sum.pos )) +   geom_point()+ scale_x_continuous(breaks = round(seq(min(positive$rd.ri), max(positive$rd.ri), by = 100),1))
positive[positive$sum.pos==max(positive$sum.pos),]
z <- data2[data2$rd.ri==553,]
qplot(rd.rp.stid,data = z)
```

### examine roads with the most negative comments in general
```{r}
negative <- data2 %>% group_by(rd.ri) %>% summarise(sum.neg = sum(neg.com))
ggplot(negative, aes(negative$rd.ri,negative$sum.neg )) +   geom_point()+ scale_x_continuous(breaks = round(seq(min(negative$rd.ri), max(negative$rd.ri), by = 100),1))
negative[negative$sum.neg==max(negative$sum.neg),]
zn <- data2[data2$rd.ri==31,]
qplot(rd.rp.stid,data = zn)
#zn2 <- zn %>% group_by(format(rp.date, '%Y-%m-%d %H')) %>% filter(rd.rp.stid == max(rd.rp.stid))
#ggplot(zn2, aes(rp.date,rd.rp.stid)) +   geom_point() + theme(axis.text.x  = element_text(angle=90, vjust=0.5))
```

### examine the areas containg the roads
```{r}
data3 <- data2
data3$rd.nm <- as.character(data3$rd.nm)
temp <- as.data.frame(do.call(rbind, strsplit(data3$rd.nm, ";")))
data3 <- cbind(temp,data3)
positive.areas <- data3 %>% group_by(V1) %>% summarise(sum.pos = sum(pos.com))
#ggplot(positive.areas, aes(V1,positive.areas$sum.pos )) +   geom_point() + theme(axis.text.x  = element_text(angle=90, vjust=0.5))
positive.areas[positive.areas$sum.pos == max(positive.areas$sum.pos),]
negative.areas <- data3 %>% group_by(V1) %>% summarise(sum.neg = sum(neg.com))
negative.areas[negative.areas$sum.neg == max(negative.areas$sum.neg),]
```

### seems like Da2ery is very popular :) BOTH positively and negatively :)
### comparing positive comments to negative comments
```{r}
general <- cbind(positive.areas , negative.areas)
View(general)
general$pos <- general$sum.pos / (general$sum.pos+general$sum.neg)
general$neg <- general$sum.neg / (general$sum.pos+general$sum.neg)
general$total <- general$sum.pos + general$sum.neg
pos <- general[general$pos > general$neg,]
neg <- general[general$pos < general$neg,]
slices <- neg$sum.neg
lbls <- neg$V1
pct <- round(slices/sum(neg$sum.neg)*100, digits = 2)
lbls <- paste(lbls, pct) 
lbls <- paste(lbls,"%",sep="") 
pie(slices,labels = lbls, col=rainbow(length(lbls)),
  	main="negative areas :( \n regarding number of negative comments")

```

### plot the percentage of negative comments for the negative areas
```{r}
ggplot(neg, aes(V1,(neg*100) )) +   geom_point() + theme(axis.text.x  = element_text(angle=90, vjust=0.5))
```
